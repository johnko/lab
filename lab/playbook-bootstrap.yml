- become: true
  become_user: root
  hosts: all
  tasks:
    - copy:
        dest: /usr/local/bin/{{ item }}
        force: true
        mode: "755"
        src: ./bin/{{ item }}
      loop:
        - cert_generateselfsigned
        - cert_info
      name: Copy bin scripts
    - copy:
        dest: '{{ item.dest }}/{{ item.file }}'
        force: true
        mode: '{{ item.mode }}'
        src: ./network/{{ item.file }}
      loop:
        - dest: /usr/local/bin
          file: get-ip
          mode: "755"
        - dest: /usr/local/sbin
          file: update-issue
          mode: "755"
      name: Copy network scripts
- become: true
  become_user: root
  hosts: sticks
  tasks:
    - copy:
        dest: '{{ item.dest }}/{{ item.file }}'
        force: true
        mode: '{{ item.mode }}'
        src: ./healthcheck/{{ item.file }}
      loop:
        - dest: /usr/local/sbin
          file: healthcheck-diff.sh
          mode: "755"
      name: Copy healthcheck scripts
    # - name: Template healthcheck scripts
    #   template:
    #     src: './healthcheck/{{ item.file }}.j2'
    #     dest: '{{ item.dest }}/{{ item.file }}'
    #     force: true
    #     mode: '{{ item.mode }}'
    #   loop:
    #     - { file: healthcheck_cron, dest: '/etc/cron.d', mode: '644' } # required no dot in cron.d filenames
    - file:
        force: true
        path: '{{ item }}'
        state: absent
      loop:
        - /etc/cron.d/healthcheck_cron
      name: Delete unused scripts
    - name: Force cron.d to reload
      shell: touch /etc/cron.d
    - community.general.lvol:
        lv: ubuntu-lv
        resizefs: true
        # - name: Create a userdata volume
        #   community.general.lvol:
        #     vg: ubuntu-vg
        #     lv: userdata
        #     size: 12g
        # - name: Create a ext4 filesystem
        #   community.general.filesystem:
        #     dev: /dev/mapper/ubuntu--vg-userdata
        #     fstype: ext4
        # - name: Mount userdata volume
        #   ansible.posix.mount:
        #     src: /dev/mapper/ubuntu--vg-userdata
        #     path: /userdata
        #     fstype: ext4
        #     passno: '2'
        #     state: mounted

        size: +100%FREE
        vg: ubuntu-vg
      name: Extend the logical volume to consume all remaining space in the volume group
- become: true
  become_user: root
  hosts: mac
  tasks:
    # - name: Link docker.sock in mac
    #   file:
    #     src: '/Users/{{ ansible_user }}/.docker/run/docker.sock'
    #     dest: /var/run/docker.sock
    #     force: true
    #     mode: '755'
    #     state: link
    - file:
        force: true
        path: '{{ item }}'
        state: absent
      loop:
        - /var/run/docker.sock
      name: Delete unused scripts
- become: true
  become_user: root
  hosts: ubuntu
  tasks:
    - name: Remove default ubuntu user
      user:
        force: true
        remove: true
        state: absent
        user: ubuntu
    - lineinfile:
        create: true
        line: '{{ ansible_user }} ALL=(ALL) NOPASSWD:ALL'
        path: /etc/sudoers.d/90-cloud-init-users
        regexp: ^{{ ansible_user }}
        state: present
        validate: /usr/sbin/visudo -cf %s
      name: Allow ansible_user to sudo NOPASSWD
    - name: Reset lab password
      shell: (echo lab;echo lab;)| passwd lab
    - apt:
        cache_valid_time: 3600
        force_apt_get: true
        update_cache: true
      name: Update apt repo and cache
    - copy:
        dest: '{{ item.dest }}/{{ item.file }}'
        force: true
        mode: '{{ item.mode }}'
        src: ./luks-autounlock/{{ item.file }}
      loop:
        - dest: /usr/local/sbin
          file: setup-luks-autounlock.sh
          mode: "755"
      name: Copy luks scripts
    - file:
        dest: /etc/networkd-dispatcher/{{ item }}.d/update-issue
        force: true
        mode: "755"
        src: /usr/local/sbin/update-issue
        state: link
      loop:
        - carrier
        - no-carrier
        - dormant
        - 'off'
        - routable
      name: Setup trigger on networkd-dispatcher
    - name: Check /etc/issue version
      register: ISSUE
      shell: cat /etc/issue | grep -q "{{ ansible_facts['lsb']['description'] }}" && echo '0' || echo '1'
    - name: Refresh base-files if OS version mismatched
      register: BASEFILES
      # found that /etc/issue is installed by base-files: dpkg -S /etc/issue
      shell: rm -v /etc/issue ; apt-get install --reinstall -y -o Dpkg::Options::="--force-confmiss" base-files
      when: (ISSUE.stdout | int) > 0
    - debug:
        var: BASEFILES.stdout_lines
      when: (ISSUE.stdout | int) > 0
    # - name: Install packages
    #   apt:
    #     force_apt_get: true
    #     name: '{{ item }}'
    #   loop:
    #     - docker.io
    #     - docker-compose
    - apt:
        force_apt_get: true
        name: '{{ item }}'
        purge: true
        state: absent
      loop:
        - docker
        - wmdocker
        - docker.io
        - docker-compose
      name: Remove unused packages
    - # https://www.cyberciti.biz/faq/ansible-apt-update-all-packages-on-ubuntu-debian-linux/
      apt:
        force_apt_get: true
        upgrade: dist
      name: Upgrade all packages
      # - name: Delete unused scripts
      #   file:
      #     path: '{{ item }}'
      #     force: true
      #     state: absent
      #   loop:
      #     - /bin/cert_generateselfsigned
      #     - /bin/cert_info
      #     - /bin/get-ip
      #     - /sbin/update-issue
      #     - /sbin/healthcheck-diff.sh
    - apt:
        clean: true
        force_apt_get: true
      name: Cleanup apt
    - name: Check if a reboot is needed
      register: reboot_required_file
      stat:
        get_md5: false
        path: /var/run/reboot-required
    - name: Reboot if kernel updated
      reboot:
        connect_timeout: 5
        msg: Reboot initiated by Ansible for kernel updates
        post_reboot_delay: 30
        pre_reboot_delay: 0
        reboot_timeout: 300
        test_command: uptime
      when: reboot_required_file.stat.exists
- become: true
  become_user: root
  hosts: ucarpservers
  tasks:
    - apt:
        force_apt_get: true
        name: '{{ item }}'
      loop:
        - ucarp
      name: Install packages
    - file:
        force: true
        mode: "755"
        path: /etc/ucarp
        state: directory
      name: Create ucarp directory if it does not exist
    - copy:
        dest: '{{ item.dest }}/{{ item.file }}'
        force: true
        mode: '{{ item.mode }}'
        src: ./ucarp/{{ item.file }}
      loop:
        - dest: /usr/lib/systemd/system
          file: ucarp@.service
          mode: "644"
        - dest: /etc/ucarp
          file: vip-common.conf
          mode: "644"
      name: Copy ucarp scripts
    - loop:
        - dest: /etc/ucarp
          file: vip-001.conf
          mode: "644"
      name: Template ucarp scripts
      template:
        dest: '{{ item.dest }}/{{ item.file }}'
        force: true
        mode: '{{ item.mode }}'
        src: ./ucarp/{{ item.file }}.j2
    - name: Configure ucarp service
      systemd_service:
        daemon_reload: true
        enabled: '{{ vars[''vars''][''ucarp_service_enabled''] }}'
        name: ucarp@001
        state: '{% if vars[''vars''][''ucarp_service_enabled''] %}started{% else %}stopped{% endif %}'
